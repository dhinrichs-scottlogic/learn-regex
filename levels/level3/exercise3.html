<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../exercises.css">
    <title>Regex Game Level 1</title>
</head>
<body>
    <div id="game-over">GAME OVER</div>
    <div id="success-message">
        <p>SUCCESS üèÜ</p>
        <a href="../level4/level4.html">next level</a>
    </div>
    <div class="control-bar">
        <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div class="buttons-container">
            <div class=button-and-number>
                <button id="btn1"></button>
                <div class="keyboard-key">1</div>
            </div>
            <div class=button-and-number>
                <button id="btn2"></button>
                <div class="keyboard-key">2</div>
            </div>
            <div class=button-and-number>
                <button id="btn3"></button>
                <div class="keyboard-key">3</div>
            </div>
        </div>
        <div id="score-points">
            <div id="progress-wrapper"><div id="progress-bar"></div></div>
        </div>
    </div>
    <script>
        const blockSpeed = 0.3;
        let currentRegex='';
        let currentMatch='';
        let currentMismatch='';
        let currentExplanation='';
        let lives = 3;
        let scorePoints = 0;

        let blockPosition = 0;
        let isFalling = true;

        document.getElementById('game-over').style.display = 'none';
        document.getElementById('success-message').style.display = 'none';

        async function getRegexData() {
            const response = await fetch('level3.json');
            const data = await response.json();
            const keys = Object.keys(data);
            const randomKey = keys[Math.floor(Math.random() * keys.length)];
            return {regex: randomKey, ...data[randomKey]};
        }

        function createBlock(blockText) {
            const block = document.createElement('div');
            block.classList.add('block');
            block.innerText = blockText;
            const minPositionVw = 20; 
            const maxPositionVw = 80; 
            const randomPositionVw = Math.random() * (maxPositionVw - minPositionVw) + minPositionVw;
            block.style.left = randomPositionVw + 'vw';
            document.body.appendChild(block);

            const fallInterval = setInterval(() => {
                if (isFalling) {
                    const top = parseFloat(block.style.top) || 0;
                    block.style.top = top + blockSpeed + 'px';

                    if (top > window.innerHeight - window.innerHeight * 0.19) {
                        clearInterval(fallInterval);
                        document.body.removeChild(block);
                        lives--;
                        let hearts = '';
                        for(let i = 0; i < lives; i++) {
                            hearts += '‚ù§Ô∏è';
                        }
                        document.getElementById('lives').innerText = hearts;
                        if(lives===0) {
                            isFalling = false;
                            document.getElementById('game-over').style.display = 'flex';
                        }
                        setButtonValues();
                    }
                }
            }, 10);
        }

        const btn1 = document.getElementById('btn1');
        const btn2 = document.getElementById('btn2');
        const btn3 = document.getElementById('btn3');

        async function setButtonValues() {
            const data = await getRegexData();
            currentRegex = data.regex;
            currentMatch = data.match;
            currentMismatch = data.mismatch;
            const correctButton = Math.floor(Math.random() * 3);
            [btn1, btn2, btn3][correctButton].innerText = currentMatch;
            [btn1, btn2, btn3].filter((_, i) => i !== correctButton).forEach(btn => {
                btn.innerText = data.mismatch[Math.floor(Math.random() * data.mismatch.length)];
            });
            createBlock(data.regex);
        }

        setButtonValues();

        [btn1, btn2, btn3].forEach(btn => {
            btn.addEventListener('click', async () => {
                if (btn.innerText === currentMatch) {
                    const oldBlock = document.querySelector('.block');
                    if (oldBlock) {
                        document.body.removeChild(oldBlock);
                    }
                    if(scorePoints === 9) {
                        document.getElementById('success-message').style.display = 'flex';
                        isFalling = false;
                    }

                    setButtonValues();
                    if(scorePoints < 10){
                        scorePoints++;
                        let progressBar = document.getElementById("progress-bar");   
                        let width = scorePoints * 10;
                        progressBar.style.width = width + '%'; 
                    }
                } else {
                    lives--;
                    let hearts = '';
                    for(let i = 0; i < lives; i++) {
                        hearts += '‚ù§Ô∏è';
                    }
                    document.getElementById('lives').innerText = hearts;
                }
                if(lives===0) {
                    isFalling = false;
                    document.getElementById('game-over').style.display = 'flex';
                    const oldBlock = document.querySelector('.block');
                    if (oldBlock) {
                        document.body.removeChild(oldBlock);
                    }
                    btn1.disabled=true;
                    btn2.disabled=true;
                    btn3.disabled=true;
                }
            });
        });

        document.addEventListener('keydown', (event) => {
            const key = event.key; 
            switch (key) {
                case '1':
                    btn1.click();
                    let button1 = document.getElementById('btn1');
                    button1.style.backgroundColor = '#fff';
                    setTimeout(function() {
                        button1.style.backgroundColor = '#ddd';
                    }, 100);
                    break;
                case '2':
                    btn2.click();
                    let button2 = document.getElementById('btn2');
                    button2.style.backgroundColor = '#fff';
                    setTimeout(function() {
                        button2.style.backgroundColor = '#ddd';
                    }, 100);
                    break;
                case '3':
                    btn3.click();
                    let button3 = document.getElementById('btn3');
                    button3.style.backgroundColor = '#fff';
                    setTimeout(function() {
                        button3.style.backgroundColor = '#ddd';
                    }, 100);
                    break;
                default:
                    break;
            }
        });

        document.addEventListener('keydown', (event) => {
            if(event.key === "Enter") {
                isFalling = !isFalling;
            }
        });

    </script>
</body>
</html>